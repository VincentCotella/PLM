{% extends 'products/base.html' %}
{% block content %}
  <div class="flex">
    <!-- Sidebar for Widgets -->
    <div class="w-1/4 bg-gray-100 p-4">
      <h2 class="font-bold mb-4">Widgets</h2>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('overview-widget')">Product Overview</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('ranges-widget')">Product Ranges</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('sites-widget')">Production Sites</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('categories-widget')">Product Categories</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('recent-modifications-widget')">Recently Modified Products</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('projects-widget')">Active Projects</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('cost-simulations-widget')">Cost Simulations</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('modification-history-widget')">Modification History</button>
      <button class="bg-blue-500 text-white w-full p-2 mb-2 rounded"
              onclick="showWidget('report-widget')">Generate Report</button>
    </div>
    <!-- Display Area for Widgets -->
    <div class="w-3/4 p-4">
      <!-- Product Overview Widget -->
      <div id="overview-widget" class="widget">
        <h2 class="text-xl font-bold mb-2">Product Overview</h2>
        <p>Total Products: {{ products.count }}</p>
      </div>
      <!-- Product Ranges Widget -->
      <div id="ranges-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Product Ranges</h2>
        <ul>
          {% for range in ranges %}
            <li class="py-2">
              <strong>{{ range.name }} ({{ range.get_category_display }})</strong> - Total Products: {{ range.product_set.count }}
            </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Production Sites Widget -->
      <div id="sites-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Production Sites</h2>
        <ul>
          {% for site in sites %}
            <li class="py-2">
              <strong>{{ site.name }} - {{ site.get_location_display }}</strong>
              <br>
              Capacity: {{ site.capacity }} units
              <br>
              Products: {{ site.product_set.count }}
            </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Product Categories Widget -->
      <div id="categories-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Product Categories</h2>
        <div class="relative" style="height: 400px;">
          <canvas id="categoriesChart" class="absolute inset-0"></canvas>
        </div>
      </div>
      <!-- Recently Modified Products Widget -->
      <div id="recent-modifications-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Recently Modified Products</h2>
        <ul>
          {% for product in products|dictsort:"-updated_at" %}
            {% if forloop.counter <= 5 %}
              <li class="py-2">
                <strong>{{ product.name }}</strong> - Last modified: {{ product.updated_at|date:"Y-m-d H:i" }}
              </li>
            {% endif %}
          {% endfor %}
        </ul>
      </div>
      <!-- Active Projects Widget -->
      <div id="projects-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Active Projects</h2>
        <ul>
          {% for project in projects %}
            <li class="py-2">
              <strong>{{ project.name }}</strong> - Status: {{ project.status }}
              <br>
              Products: {{ project.products.count }}
            </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Cost Simulations Widget -->
      <div id="cost-simulations-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Simulations de Coût</h2>
        <a href="{% url 'products:cost_simulation_create' %}" class="bg-green-500 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mb-4 inline-block">Nouvelle Simulation</a>
        <ul>
            {% for simulation in simulations %}
                <li class="py-2 border-b">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong><a href="{% url 'products:cost_simulation_detail' simulation.id %}" class="text-blue-500 hover:underline">{{ simulation.product.name }}</a></strong> - Prix Calculé: {{ simulation.calculated_price }}€
                        </div>
                        <a href="{% url 'products:cost_simulation_detail' simulation.id %}" class="text-blue-500 hover:text-blue-700">
                            <!-- Eye Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 inline-block"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </a>
                    </div>
                </li>
            {% empty %}
                <li class="py-2 text-gray-500">Aucune simulation de coût disponible.</li>
            {% endfor %}
        </ul>
      </div>
      <!-- Modification History Widget -->
      <div id="modification-history-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Modification History</h2>
        <ul>
          {% for modification in modification_history %}
            <li class="py-2">
              Product: <strong>{{ modification.product.name }}</strong>
              <br>
              Modified by: {{ modification.modified_by.username }} - Date: {{ modification.date_modified|date:"Y-m-d H:i" }}
              <br>
              Change Description: {{ modification.change_description }}
            </li>
          {% endfor %}
        </ul>
      </div>
      <!-- Generate Report Widget -->
      <div id="report-widget" class="widget hidden">
        <h2 class="text-xl font-bold mb-2">Generate Production Reports</h2>
        <p>Click below to generate a detailed production report for all active products.</p>
        <a href="{% url 'products:generate_report' %}"
           class="bg-blue-500 text-white p-2 rounded">Generate Report</a>
      </div>
    </div>
  </div>
  <!-- JavaScript to Handle Widget Display and Chart Initialization -->
  <script>
    // Flag to ensure the chart initializes only once
    var categoriesChartInitialized = false;

    function showWidget(widgetId) {
        var widgets = document.querySelectorAll('.widget');
        widgets.forEach(widget => widget.classList.add('hidden'));
        var targetWidget = document.getElementById(widgetId);
        if (targetWidget) {
            targetWidget.classList.remove('hidden');

            // Initialize Chart.js only once when the categories widget is shown
            if (widgetId === 'categories-widget' && !categoriesChartInitialized) {
                var ctx = document.getElementById('categoriesChart').getContext('2d');
                var agrifoodData = JSON.parse('{{ agrifood_products_data|escapejs }}');
                var perfumeryData = JSON.parse('{{ perfumery_products_data|escapejs }}');

                var agrifoodCount = agrifoodData.length;
                var perfumeryCount = perfumeryData.length;

                // Ensure counts are valid numbers
                agrifoodCount = Number(agrifoodCount) || 0;
                perfumeryCount = Number(perfumeryCount) || 0;

                var categoriesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Agrifood', 'Perfumery'],
                        datasets: [{
                            label: '# of Products',
                            data: [agrifoodCount, perfumeryCount],
                            backgroundColor: ['#FF6384', '#36A2EB'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Product Categories Distribution'
                            }
                        }
                    }
                });

                categoriesChartInitialized = true;
            }
        }
    }

    // Initialize the overview widget by default
    document.addEventListener('DOMContentLoaded', function () {
        showWidget('overview-widget');
    });
  </script>
{% endblock %}
